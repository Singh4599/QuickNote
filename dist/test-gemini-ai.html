<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini AI Medical Analysis Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="js/auth-simple.js"></script>
  <script src="js/gemini-ai-medical.js"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
  <div class="container mx-auto px-4 max-w-4xl">
    <div class="bg-white rounded-lg shadow-lg p-8">
      <h1 class="text-3xl font-bold text-center mb-8 text-slate-800">
        üß† Gemini AI Medical Analysis Test
      </h1>
      
      <!-- API Status -->
      <div class="mb-8 p-4 bg-blue-50 rounded-lg">
        <h2 class="text-xl font-bold mb-2">API Status</h2>
        <div id="apiStatus" class="text-gray-600">
          Checking Gemini AI connection...
        </div>
        <button onclick="testAPIConnection()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Test Connection
        </button>
      </div>

      <!-- Image Analysis Test -->
      <div class="mb-8 p-6 bg-green-50 rounded-lg">
        <h2 class="text-xl font-bold mb-4">üñºÔ∏è Medical Image Analysis</h2>
        <p class="text-gray-600 mb-4">Upload an X-ray, MRI, CT scan, or any medical image for AI analysis</p>
        
        <input type="file" id="imageInput" accept="image/*" class="mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        
        <button onclick="analyzeImage()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700" disabled id="analyzeImageBtn">
          Analyze Medical Image
        </button>
        
        <div id="imagePreview" class="mt-4 hidden">
          <img id="previewImg" class="max-w-xs rounded border" />
        </div>
      </div>

      <!-- Text Analysis Test -->
      <div class="mb-8 p-6 bg-yellow-50 rounded-lg">
        <h2 class="text-xl font-bold mb-4">üí¨ Symptom Analysis</h2>
        <p class="text-gray-600 mb-4">Describe symptoms or medical conditions for AI analysis</p>
        
        <textarea id="symptomText" class="w-full p-3 border rounded-lg mb-4" rows="4" placeholder="Example: I have been experiencing chest pain for the past 2 days, especially when I breathe deeply. The pain is sharp and located on the left side..."></textarea>
        
        <button onclick="analyzeSymptoms()" class="bg-yellow-600 text-white px-6 py-2 rounded hover:bg-yellow-700">
          Analyze Symptoms
        </button>
      </div>

      <!-- PDF Analysis Test -->
      <div class="mb-8 p-6 bg-purple-50 rounded-lg">
        <h2 class="text-xl font-bold mb-4">üìÑ Medical Document Analysis</h2>
        <p class="text-gray-600 mb-4">Upload a medical PDF (lab report, radiology report, etc.)</p>
        
        <input type="file" id="pdfInput" accept=".pdf" class="mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
        
        <button onclick="analyzePDF()" class="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700" disabled id="analyzePDFBtn">
          Analyze Medical Document
        </button>
      </div>

      <!-- Results Display -->
      <div id="resultsContainer" class="hidden">
        <h2 class="text-2xl font-bold mb-4 text-slate-800">üî¨ AI Analysis Results</h2>
        <div id="analysisResults" class="bg-white border rounded-lg p-6">
          <!-- Results will be displayed here -->
        </div>
      </div>

      <!-- Console Output -->
      <div class="mt-8 p-6 bg-gray-50 rounded-lg">
        <h2 class="text-xl font-bold mb-4">Console Output</h2>
        <div id="consoleOutput" class="bg-black text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto">
          <!-- Console messages will appear here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Capture console logs
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    const consoleOutput = document.getElementById('consoleOutput');

    function addToConsole(message, type = 'log') {
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        log: 'text-green-400',
        error: 'text-red-400',
        warn: 'text-yellow-400'
      };
      const color = colors[type] || 'text-green-400';
      consoleOutput.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    console.log = function(...args) {
      originalLog.apply(console, args);
      addToConsole(args.join(' '), 'log');
    };

    console.error = function(...args) {
      originalError.apply(console, args);
      addToConsole(args.join(' '), 'error');
    };

    console.warn = function(...args) {
      originalWarn.apply(console, args);
      addToConsole(args.join(' '), 'warn');
    };

    // Test API connection
    async function testAPIConnection() {
      const statusDiv = document.getElementById('apiStatus');
      
      if (!window.GeminiMedicalAI) {
        statusDiv.innerHTML = '‚ùå Gemini AI not loaded';
        return;
      }

      if (window.GeminiMedicalAI.apiKey === 'YOUR_GEMINI_API_KEY') {
        statusDiv.innerHTML = '‚ö†Ô∏è API key not configured. Please add your Gemini API key to js/gemini-ai-medical.js';
        return;
      }

      statusDiv.innerHTML = 'üîÑ Testing connection...';
      
      const success = await window.GeminiMedicalAI.testConnection();
      
      if (success) {
        statusDiv.innerHTML = '‚úÖ Gemini AI connected successfully! Ready for medical analysis.';
      } else {
        statusDiv.innerHTML = '‚ùå Connection failed. Check your API key and internet connection.';
      }
    }

    // Handle image input
    document.getElementById('imageInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const btn = document.getElementById('analyzeImageBtn');
      const preview = document.getElementById('imagePreview');
      const img = document.getElementById('previewImg');
      
      if (file) {
        btn.disabled = false;
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
          img.src = e.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        btn.disabled = true;
        preview.classList.add('hidden');
      }
    });

    // Handle PDF input
    document.getElementById('pdfInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const btn = document.getElementById('analyzePDFBtn');
      
      btn.disabled = !file;
    });

    // Analyze medical image
    async function analyzeImage() {
      const fileInput = document.getElementById('imageInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select an image file');
        return;
      }

      if (!window.GeminiMedicalAI) {
        alert('Gemini AI not loaded');
        return;
      }

      console.log('üñºÔ∏è Starting medical image analysis...');
      
      try {
        // Convert file to base64
        const base64 = await fileToBase64(file);
        const fileType = file.type.split('/')[1];
        
        // Analyze with Gemini AI
        const result = await window.GeminiMedicalAI.analyzeMedicalImage(base64, fileType);
        
        displayResults(result, 'Medical Image Analysis');
        
      } catch (error) {
        console.error('Image analysis error:', error);
        alert('Analysis failed: ' + error.message);
      }
    }

    // Analyze symptoms
    async function analyzeSymptoms() {
      const textArea = document.getElementById('symptomText');
      const text = textArea.value.trim();
      
      if (!text) {
        alert('Please enter some symptoms or medical information');
        return;
      }

      if (!window.GeminiMedicalAI) {
        alert('Gemini AI not loaded');
        return;
      }

      console.log('üí¨ Starting symptom analysis...');
      
      try {
        const result = await window.GeminiMedicalAI.analyzeMedicalText(text);
        displayResults(result, 'Symptom Analysis');
        
      } catch (error) {
        console.error('Symptom analysis error:', error);
        alert('Analysis failed: ' + error.message);
      }
    }

    // Analyze PDF document
    async function analyzePDF() {
      const fileInput = document.getElementById('pdfInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select a PDF file');
        return;
      }

      if (!window.GeminiMedicalAI) {
        alert('Gemini AI not loaded');
        return;
      }

      console.log('üìÑ Starting PDF document analysis...');
      
      try {
        // Convert file to base64
        const base64 = await fileToBase64(file);
        
        // Analyze with Gemini AI
        const result = await window.GeminiMedicalAI.analyzeMedicalDocument(base64);
        
        displayResults(result, 'Medical Document Analysis');
        
      } catch (error) {
        console.error('PDF analysis error:', error);
        alert('Analysis failed: ' + error.message);
      }
    }

    // Display analysis results
    function displayResults(result, title) {
      const container = document.getElementById('resultsContainer');
      const resultsDiv = document.getElementById('analysisResults');
      
      const html = `
        <div class="mb-4">
          <h3 class="text-xl font-bold text-slate-800 mb-2">
            ${title}
          </h3>
          <div class="flex items-center gap-2 mb-4">
            <span class="px-3 py-1 rounded-full text-sm font-medium ${
              result.risk_level === 'high' ? 'bg-red-100 text-red-700' :
              result.risk_level === 'medium' ? 'bg-yellow-100 text-yellow-700' :
              'bg-green-100 text-green-700'
            }">
              Risk Level: ${result.risk_level.toUpperCase()}
            </span>
            <span class="text-sm text-slate-500">${new Date().toLocaleString()}</span>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <h4 class="font-semibold text-slate-700 mb-2">Summary</h4>
            <p class="text-slate-600 bg-slate-50 p-3 rounded">${result.summary}</p>
          </div>

          <div>
            <h4 class="font-semibold text-slate-700 mb-2">Key Findings</h4>
            <ul class="list-disc list-inside space-y-1 text-slate-600 bg-slate-50 p-3 rounded">
              ${result.key_findings.map(finding => `<li>${finding}</li>`).join('')}
            </ul>
          </div>

          <div>
            <h4 class="font-semibold text-slate-700 mb-2">Recommended Follow-ups</h4>
            <ul class="list-disc list-inside space-y-1 text-slate-600 bg-slate-50 p-3 rounded">
              ${result.followups.map(followup => `<li>${followup}</li>`).join('')}
            </ul>
          </div>

          <div>
            <h4 class="font-semibold text-slate-700 mb-2">Patient-Friendly Explanation</h4>
            <p class="text-slate-600 bg-blue-50 p-3 rounded border-l-4 border-blue-400">${result.patient_friendly_explainer}</p>
          </div>
        </div>

        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
          <p class="text-sm text-yellow-800">
            <strong>Important:</strong> This AI analysis is for informational purposes only and should not replace professional medical advice, diagnosis, or treatment. Always consult with qualified healthcare providers for medical decisions.
          </p>
        </div>
      `;
      
      resultsDiv.innerHTML = html;
      container.classList.remove('hidden');
      
      // Scroll to results
      container.scrollIntoView({ behavior: 'smooth' });
    }

    // Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üß™ Gemini AI Test Page initialized');
      
      // Auto-test connection after a short delay
      setTimeout(testAPIConnection, 1000);
    });
  </script>
</body>
</html>
