<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Role Detection Test - MediVerse AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth-simple.js"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
  <div class="container mx-auto px-4 max-w-4xl">
    <div class="bg-white rounded-lg shadow-lg p-8">
      <h1 class="text-3xl font-bold text-center mb-8 text-slate-800">
        Role Detection Test
      </h1>
      
      <!-- Test Signup -->
      <div class="mb-8 p-6 bg-blue-50 rounded-lg">
        <h2 class="text-xl font-bold mb-4">Test Signup</h2>
        <form id="testSignup" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Role</label>
            <select id="testRole" class="w-full p-3 border rounded-lg">
              <option value="patient">Patient</option>
              <option value="doctor">Doctor</option>
              <option value="hospital">Hospital</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Name</label>
            <input type="text" id="testName" class="w-full p-3 border rounded-lg" placeholder="Test User">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input type="email" id="testEmail" class="w-full p-3 border rounded-lg" placeholder="test@example.com">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Password</label>
            <input type="password" id="testPassword" class="w-full p-3 border rounded-lg" value="password123">
          </div>
          <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">
            Test Signup
          </button>
        </form>
      </div>

      <!-- Test Login -->
      <div class="mb-8 p-6 bg-green-50 rounded-lg">
        <h2 class="text-xl font-bold mb-4">Test Login</h2>
        <form id="testLogin" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input type="email" id="loginEmail" class="w-full p-3 border rounded-lg" placeholder="test@example.com">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Password</label>
            <input type="password" id="loginPassword" class="w-full p-3 border rounded-lg" value="password123">
          </div>
          <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700">
            Test Login
          </button>
        </form>
      </div>

      <!-- Current User Info -->
      <div class="p-6 bg-yellow-50 rounded-lg">
        <h2 class="text-xl font-bold mb-4">Current User Info</h2>
        <div id="userInfo" class="space-y-2">
          <p>Loading...</p>
        </div>
        <button onclick="checkCurrentUser()" class="mt-4 bg-yellow-600 text-white px-4 py-2 rounded-lg">
          Refresh User Info
        </button>
      </div>

      <!-- Console Output -->
      <div class="mt-8 p-6 bg-gray-50 rounded-lg">
        <h2 class="text-xl font-bold mb-4">Console Output</h2>
        <div id="consoleOutput" class="bg-black text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto">
          <!-- Console messages will appear here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Capture console logs
    const originalLog = console.log;
    const originalError = console.error;
    const consoleOutput = document.getElementById('consoleOutput');

    function addToConsole(message, type = 'log') {
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? 'text-red-400' : 'text-green-400';
      consoleOutput.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    console.log = function(...args) {
      originalLog.apply(console, args);
      addToConsole(args.join(' '), 'log');
    };

    console.error = function(...args) {
      originalError.apply(console, args);
      addToConsole(args.join(' '), 'error');
    };

    // Test functions
    async function checkCurrentUser() {
      const userInfo = document.getElementById('userInfo');
      
      try {
        // Check Supabase session
        const { data: { session } } = await window.supabaseClient.auth.getSession();
        
        if (session && session.user) {
          const user = session.user;
          const metadata = user.user_metadata || {};
          
          console.log('üîç Current session user:', user);
          console.log('üîç User metadata:', metadata);
          
          userInfo.innerHTML = `
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>Email Confirmed:</strong> ${user.email_confirmed_at ? 'Yes' : 'No'}</p>
            <p><strong>Role:</strong> ${metadata.role || 'Not set'}</p>
            <p><strong>Full Name:</strong> ${metadata.full_name || 'Not set'}</p>
            <p><strong>Created:</strong> ${new Date(user.created_at).toLocaleString()}</p>
            <p><strong>Last Sign In:</strong> ${user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleString() : 'Never'}</p>
          `;
        } else {
          userInfo.innerHTML = '<p>No user logged in</p>';
          console.log('‚ùå No active session');
        }
      } catch (error) {
        console.error('Error checking user:', error);
        userInfo.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
      }
    }

    // Signup form handler
    document.getElementById('testSignup').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const role = document.getElementById('testRole').value;
      const name = document.getElementById('testName').value;
      const email = document.getElementById('testEmail').value;
      const password = document.getElementById('testPassword').value;
      
      console.log('üöÄ Testing signup with role:', role);
      
      const userData = {
        fullName: name,
        role: role
      };
      
      if (window.SimpleAuth) {
        const result = await window.SimpleAuth.signUp(email, password, userData);
        console.log('Signup result:', result);
      } else {
        console.error('SimpleAuth not available');
      }
    });

    // Login form handler
    document.getElementById('testLogin').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      console.log('üöÄ Testing login');
      
      if (window.SimpleAuth) {
        const result = await window.SimpleAuth.signIn(email, password);
        console.log('Login result:', result);
        
        // Don't redirect, just show the result
        setTimeout(() => {
          checkCurrentUser();
        }, 1000);
      } else {
        console.error('SimpleAuth not available');
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üîß Role Detection Test initialized');
      setTimeout(checkCurrentUser, 1000);
    });
  </script>
</body>
</html>
